version: "3.9"
services:
  api:
    build: ../backend
    ports:
      - "8080:8080"
    depends_on:
      - pg-raw
      - pg-metrics
    environment:
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE:-dev}
      SPRING_DATASOURCE_RAW_URL: jdbc:postgresql://pg-raw:5432/raw_db
      SPRING_DATASOURCE_RAW_USERNAME: ${RAW_DB_USER:-raw_user}
      SPRING_DATASOURCE_RAW_PASSWORD: ${RAW_DB_PASS:-raw_pass}
      SPRING_DATASOURCE_METRICS_URL: jdbc:postgresql://pg-metrics:5432/metrics_db
      SPRING_DATASOURCE_METRICS_USERNAME: ${METRICS_DB_USER:-metrics_user}
      SPRING_DATASOURCE_METRICS_PASSWORD: ${METRICS_DB_PASS:-metrics_pass}
      SECURITY_JWT_SECRET: ${JWT_SECRET:-change-me-please}
      SECURITY_JWT_EXPIRATION-MS: ${JWT_EXPIRATION_MS:-86400000}
      SECURITY_DEMO-USER_USERNAME: ${DEMO_USERNAME:-admin}
      SECURITY_DEMO-USER_PASSWORD: ${DEMO_PASSWORD:-admin123}
      STORAGE_OCY_BASE-URL: ${OCI_BASE_URL:-https://objectstorage.us-ashburn-1.oraclecloud.com}
      STORAGE_OCY_EXPIRATION-SECONDS: ${OCI_EXPIRATION_SECONDS:-900}
      STORAGE_OCY_NAMESPACE: ${OCI_NAMESPACE:-your-namespace}
      STORAGE_OCY_REGION: ${OCI_REGION:-us-ashburn-1}
      STORAGE_OCY_CONFIG-FILE: ${OCI_CONFIG_FILE:-~/.oci/config}
      STORAGE_OCY_PROFILE: ${OCI_PROFILE:-DEFAULT}
      STORAGE_OCY_BUCKET-NAME: ${OCI_BUCKET:-data-platform-bucket}
    volumes:
      - ${OCI_CONFIG_DIR:-~/.oci}:/root/.oci:ro
    # image build can be set later; placeholder

  pg-raw:
    image: postgres:15
    environment:
      POSTGRES_DB: raw_db
      POSTGRES_USER: raw_user
      POSTGRES_PASSWORD: raw_pass
    ports:
      - "5432:5432"

  pg-metrics:
    image: postgres:15
    environment:
      POSTGRES_DB: metrics_db
      POSTGRES_USER: metrics_user
      POSTGRES_PASSWORD: metrics_pass
    ports:
      - "5433:5432"

  # OCY: external service; if local S3-compatible needed, uncomment minio.
  # minio:
  #   image: quay.io/minio/minio:RELEASE.2024-04-18T19-09-19Z
  #   command: server /data --console-address ":9001"
  #   environment:
  #     MINIO_ROOT_USER: minioadmin
  #     MINIO_ROOT_PASSWORD: minioadmin
  #   ports:
  #     - "9000:9000"
  #     - "9001:9001"
  #   volumes:
  #     - minio-data:/data

volumes:
  minio-data:
